<html>

<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>
     TensorFlow2.0 入门 | EdenBlog
</title>
<link rel="shortcut icon" href="https://zhuoquany.github.io/favicon.ico?v=1583397802920">
<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"> -->
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://zhuoquany.github.io/styles/main.css">
<!-- js -->
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://zhuoquany.github.io/media/js/jquery.sticky-sidebar.min.js"></script>
<!--<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>-->
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>


   


 <!--妹纸挂件-->
 <!--<script src="https://blog-static.cnblogs.com/files/yyhh/L2Dwidget.min.js"></script> -->

 <script  src="https://zhuoquany.github.io/media/js/L2Dwidget.min.js"></script>

<script type="text/javascript">
L2Dwidget.init();
</script>
    
</head>

<body>
    <div class="main">
        <div class="header">
    <div class="nav">
        <div class="logo">
            <a href="https://zhuoquany.github.io">
                <img class="avatar" src="https://zhuoquany.github.io/images/avatar.png?v=1583397802920" alt="">
            </a>
            <div class="site-title">
                <h1>
                    EdenBlog
                </h1>
            </div>
        </div>
        <span class="menu-btn fa fa-align-justify"></span>
        <div class="menu-container">
            <ul>
                
                    
                            <li>
                                <a href="/" class="menu">
                                    首页
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/archives" class="menu">
                                    归档
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/tags" class="menu">
                                    标签
                                </a>
                            </li>
                            
                                
                    
                            <li>
                                <a href="/post/about" class="menu">
                                    关于
                                </a>
                            </li>
                            
                                
            </ul>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $(".menu-btn").click(function() {
            $(".menu-container").slideToggle();
        });
        $(window).resize(function() {

            if (window.matchMedia('(min-width: 960px)').matches) {
                $(".menu-container").css('display', 'block')
            } else {
                $(".menu-container").css('display', 'none')
            }

        });
    });
</script>

        <div id="main-content" class="post-detail main-container">
            <!-- left -->
            <div id="content" class="main-container-left">
                <article class="post i-card">
                    <h2 class="post-title">
                         TensorFlow2.0 入门
                    </h2>
                    <div class="post-info">
                        <time class="post-time">2020-02-25</time>
                        
                    </div>
                    
                    <div class="post-content">
                        <p>包含前向传播，手写数字识别，以及遇到的一些错误的解决方法。</p>
<!-- more  -->
<h2 id="前向传播">前向传播</h2>
<pre><code class="language-python">#conding:utf-8
import  tensorflow as tf
from tensorflow  import  keras
from  tensorflow.keras import datasets
import  os
os.environ['TF_CPP_MIN_LOG_LEVEL']='2'
'''
0 全部输出
2 仅输出错误信息
'''
'''
loss = nan 梯度爆炸'''
# x:[60k,28,28]
# y: [60k]
(x,y),(x_test,y_test) = datasets.mnist.load_data()
# 转换为Tensor
x = tf.convert_to_tensor(x,dtype=tf.float32) / 255
y = tf.convert_to_tensor(y,dtype=tf.int32)

x_test = tf.convert_to_tensor(x_test,dtype=tf.float32) / 255
y_test = tf.convert_to_tensor(y_test,dtype=tf.int32)
print(x.shape,y.shape,x.dtype,y.dtype)
print(tf.reduce_min(x),tf.reduce_max(x))
print(tf.reduce_min(y),tf.reduce_max(y))

train_db = tf.data.Dataset.from_tensor_slices((x,y)).batch(128)
test_db = tf.data.Dataset.from_tensor_slices((x_test,y_test)).batch(128)
train_iter = iter(train_db) # 生成迭代器
sample = next(train_iter)
print('batch :',sample[0].shape)

# [b,728] =&gt; [b,512] =&gt; [b,128]  =&gt; [b,10]
w1 = tf.Variable(tf.random.truncated_normal([784,256],stddev=0.1))
b1 = tf.Variable(tf.zeros([256]))
w2= tf.Variable(tf.random.truncated_normal([256,128],stddev=0.1))
b2 = tf.Variable(tf.zeros([128]))
w3 = tf.Variable(tf.random.truncated_normal([128,10],stddev=0.1))
b3 = tf.Variable(tf.zeros([10]))
lr = 1e-3
# h1 = x@w1 + b1
for epoch in range(10):
    for step,(x,y) in enumerate(train_db):
        # x:[128,28,28]
        # y: [128]
        # x: [b,28*28]
        # h1 = x@w1 + b1;
        # [b.784]@[784,256] + [256] =&gt;  [b,256] +[256] =&gt; b[256] + [256]
        x = tf.reshape(x,[-1,28*28])
        with tf.GradientTape() as  tape:
            h1 = x@w1 + tf.broadcast_to(b1,[x.shape[0],256])
            h1 = tf.nn.relu(h1)
            h2 = h1@w2 + b2
            out = h2@w3 + b3

            # compute loss
            # out[b,10]
            # y: [b] =&gt; [b,10]
            y_onehot = tf.one_hot(y,depth=10)
            # mes = mean((y-out)^2)
            # [b,10]
            loss = tf.square(y_onehot - out)
            # mean: scalar
            loss = tf.reduce_mean(loss)
        grads = tape.gradient(loss,[w1,b1,w2,b2,w3,b3])
        w1.assign_sub(lr * grads[0])
        b1.assign_sub(lr * grads[1])
        w2.assign_sub(lr * grads[2])
        b2.assign_sub(lr * grads[3])
        w3.assign_sub(lr * grads[4])
        b3.assign_sub(lr * grads[5])
        '''
        w1 = w1 - lr * grads[0]
        b1 =b1 - lr * grads[1]
        w2 = w2 - lr * grads[2]
        b2 = b2 - lr * grads[3]
        w3 = w3 - lr * grads[4]
        b3 = b3 - lr * grads[5]
        '''
        if step % 100 == 0:
            print(epoch,step,'loss = ',float(loss))

    total_correct = 0
    total_num = 0
    for  step,(x,y) in enumerate(test_db):
        x = tf.reshape(x,[-1,28*28])
        h1 = tf.nn.relu(x@w1+b1)
        h2 = tf.nn.relu(h1@w2 + b2)
        out = h2@w3 + b3
        # int 64

        prob = tf.nn.softmax(out,axis=1)
        pred = tf.argmax(prob,axis=1)
        #print(pred.shape,out.shape,prob.shape)
        pred = tf.cast(pred,dtype=tf.int32)
        #print(pred.shape,y.shape)
        correct = tf.cast(tf.equal(pred,y),dtype=tf.int32)
        correct = tf.reduce_sum(correct)

        total_correct += int(correct)
        total_num += x.shape[0]
    acc = total_correct / total_num
    print(&quot;test acc: &quot;,acc)
</code></pre>
<h2 id="mnist数据体验">mnist数据体验</h2>
<pre><code class="language-python">#conding:utf-8

# 导入TensorFlow和tf.keras

import tensorflow as tf
from tensorflow import keras
from  tensorflow.keras import datasets

from keras.datasets import boston_housing

# 导入辅助库

import numpy as np
import matplotlib.pyplot as plt

#(train_images, train_labels), (test_images, test_labels) = datasets.mnist.load_data()

(train_images, train_labels), (test_images, test_labels) = boston_housing.load_data()
class_names = ['0','1','2','3','4','5','6','7','8','9']

train_images = train_images / 255.0
test_images = test_images / 255.0

model = keras.Sequential([
    keras.layers.Flatten(input_shape=(28, 28)),
    keras.layers.Dense(128, activation=tf.nn.relu),
    keras.layers.Dense(10, activation=tf.nn.softmax)
])
model.compile(optimizer='adam',
              loss='sparse_categorical_crossentropy',
              metrics=['accuracy'])

model.fit(train_images, train_labels, epochs=5)

test_loss, test_acc = model.evaluate(test_images, test_labels)
print('Test accuracy:', test_acc)
</code></pre>
<h2 id="遇见的问题">遇见的问题</h2>
<h3 id="导入fashionminst数据问题">导入fashionminst数据问题</h3>
<p>报错</p>
<pre><code class="language-python">EOFError: Compressed file ended before the end-of-stream marker was reached
</code></pre>
<p>解决问题方法：</p>
<p>fashion-mnist数据缓存位置 ：</p>
<pre><code class="language-python"> C:\Users\（你的Windows用户名）\.keras\datasets\\fashion-mnist
</code></pre>
<p>删除fashion-mnist文件夹，然后重新加载数据就可以了。</p>
<h3 id="fashion-minst数据集更换国内可用连接">fashion-minst数据集更换国内可用连接</h3>
<p>在你的TensorFlow库文件里面，更改fashion_mnist.py文件，具体路径如下：</p>
<pre><code>envs\\tensorflow\lib\site-packages\tensorflow\python\keras\datasets\fashion_mnist.py
</code></pre>
<p>把代码中的</p>
<p>base = 'https://storage.googleapis.com/tensorflow/tf-keras-datasets/'</p>
<p>替换为如下连接：  base = 'http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/'</p>
<p>其他数据源也可以通过类似的方法更改，不错连接要准确。</p>

                    </div>
                </article>
                <!--  -->
                
                <div class="next-post">
                    <div class="next">下一篇</div>
                    <a href="https://zhuoquany.github.io/post/oracle-de-an-zhuang-he-shi-yong/">
                        <h3 class="post-title">
                            oracle的安装和使用
                        </h3>
                    </a>
                </div>
                
                <div id="disqus_thread"></div>
                <div id="gitalk-container"></div>
            </div>
            <!-- middle -->
            <div class="main-container-middle"></div>
            <!-- right -->
            <div id="sidebar" class="main-container-right">
                
                <!-- toc -->
                
    <div class="toc-card i-card ">
        <div class="toc-title i-card-title">目录</div>
        <div class="toc-content">
            <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%89%8D%E5%90%91%E4%BC%A0%E6%92%AD">前向传播</a></li>
<li><a href="#mnist%E6%95%B0%E6%8D%AE%E4%BD%93%E9%AA%8C">mnist数据体验</a></li>
<li><a href="#%E9%81%87%E8%A7%81%E7%9A%84%E9%97%AE%E9%A2%98">遇见的问题</a>
<ul>
<li><a href="#%E5%AF%BC%E5%85%A5fashionminst%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98">导入fashionminst数据问题</a></li>
<li><a href="#fashion-minst%E6%95%B0%E6%8D%AE%E9%9B%86%E6%9B%B4%E6%8D%A2%E5%9B%BD%E5%86%85%E5%8F%AF%E7%94%A8%E8%BF%9E%E6%8E%A5">fashion-minst数据集更换国内可用连接</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
        <script>
            function locateCatelogList() {
                /*获取文章目录集合,可通过:header过滤器*/
                var alis = $('.post-content :header');
                /*获取侧边栏目录列表集合**/
                var sidebar_alis = $('.markdownIt-TOC a');
                /*获取滚动条到顶部的距离*/
                var scroll_height = $(window).scrollTop();
                for (var i = 0; i < alis.length; i++) {
                    /*获取锚点集合中的元素分别到顶点的距离*/
                    var a_height = $(alis[i]).offset().top;
                    if (a_height < scroll_height) {
                        /*高亮显示*/
                        sidebar_alis.removeClass('on');
                        $(sidebar_alis[i]).addClass('on');
                    }
                }
            }
            $(function() {
                /*绑定滚动事件 */
                $(window).bind('scroll', locateCatelogList);
            });
        </script>
    </div>
    
                

                </div>




            </div>


          <!--  <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://zhuoquany.github.io/atom.xml" target="_blank">RSS</a> |
  <a rel="nofollow" href="http://www.beian.miit.gov.cn" target="_blank">网站备案号:蜀ICP备19027589号</a>
</div>
 -->

                <!-- 引入代码高亮的 js -->
                <!--代码熏染风格 atom-one-dark.min.css -->
                <link rel="stylesheet"
                    href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css">
                <!--引入熏染js-->
                <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
                <script>hljs.initHighlightingOnLoad();</script>


                <!--代码一键复制-->
                <!--引入第三方clipboard.js-->
                <!--样式在assets\styles\common\index.less-->
                <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
                <script type="text/javascript">
                    /*页面载入完成后，创建复制按钮*/
                    !function (e, t, a) {
                        /* code */
                        var initCopyCode = function () {
                            var copyHtml = '';
                            copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
                            copyHtml += '<span>复制</span>';
                            copyHtml += '</button>';
                            $("code").before(copyHtml);
                            new ClipboardJS('.btn-copy', {
                                target: function (trigger) {
                                    return trigger.nextElementSibling;
                                }
                            });
                        }
                        initCopyCode();
                    }(window, document);
                   
                </script>
                
                







            </div>
            <script>
                $('#sidebar').stickySidebar({
                    topSpacing: 80,
                    // bottomSpacing: 60
                });
            </script>
            
</body>

</html>